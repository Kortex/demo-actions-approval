name: Branch naming test

on:
  push:
    branches:
      - stage/**
  pull_request:
    branches:
      - stage/**

jobs:
  limit-to-certain-branch:
    runs-on: ubuntu-20.04
    name: "My staged jobs"
    defaults:
      run:
        shell: bash

    steps:

      - name: Calc branch name
        run: echo "CALC_BRANCH=refs/heads/stage/${{ matrix.branch }}" >> "$GITHUB_ENV"

      - name: Echo branch name
        run: echo ${GITHUB_REF##*/}

      - name: Echo GITHUB Ref
        run: echo $GITHUB_REF

      - name: Echo Branch Base Parsed
        run: |
          echo $GITHUB_BASE_REF
          echo ${GITHUB_BASE_REF##*/}

      - name: Echo Head Base Parsed
        run: |
          echo $GITHUB_HEAD_REF
          echo ${GITHUB_HEAD_REF##*/}

      - name: Figure out stage name
        run: |
          stage=
          if [[ $GITHUB_EVENT_NAME == 'pull_request' ]]; then
            stage=${GITHUB_BASE_REF##*/}
          elif [[ $GITHUB_EVENT_NAME == 'push' ]]; then
            stage=${GITHUB_REF##*/}
          else
            echo "Cannot figure out stage"
            exit 2
          fi
          echo $stage
          echo "STAGE=$stage" >> "$GITHUB_ENV"
#      - name: Echo calc branch
#        run: echo ${{ env.CALC_BRANCH }}

      - name: Do important stuff only for branch
        run: echo "Something very important here ${{ env.STAGE }}"
        #if: github.event_name == 'push' && github.ref == github.base_ref
